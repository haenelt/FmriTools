# Computational model of ocular dominance columns
The stripe-like tangential pattern of human ocular dominance columns (ODCs) in striate cortex are modeled based on a simple parametric model introduced by Rojer and Schwartz (1990) and already used by (Chaimow et al., 2011, 2016, 2018a, 2018b; Goncalves et al., 2015). In this model, ODCs are generated by applying an anisotropic band-pass filter to a white noise pattern followed by a thresholding operation.

The irregularity, branchedness and non-uniformity of ODC patterns suggest a stochastic component as white noise. The stripe-like structure suggests a description in the spatial frequency domain. The relative constant local width and high degree of parallelism favours an anisotropic filter. The binary nature of ODCs suggests some sort of threshold function. In general, any operation which provides the equivalent of a band-pass filter, and a selection operation, is sufficient to qualitatively synthesise these patterns.

An advantage of this model is that only a small amount of parameters control the spatial frequency, branchedness and regularity of the columnar pattern.

The band-pass filter of the model has Gaussian shape. This results in column regularity which is too large if compared to real ocular dominance columns. Additionally, changes in column orientation cannot be modeled. Therefore, the simulations are more similar to histological data when compared only over short distances (Rojer and Schwartz, 1990).

The overall model makes it possible to vary the spatial frequency, branchedness, irregularity and orientation of the pattern, as well as the response amplitude, the width of the response point-spread function, the amount of measurement noise and the pixel size of the MR measurement.

## Implementation
The generation of ODCs mainly follows the derivation described in (Chaimow et al. 2011, 2018a). Input and output variables are two dimensional fields (real-valued functions on $\mathbb{R}^2$), representing quantities in two-dimensional image space.

### Input parameters
~~~python
# array size of the simulated patch of cortex
Nx_sim = 2048
Ny_sim = 2048

# field of view in mm
FOVx = 200
FOVy = 200

# array size of the MR image
Nx_mri = 200
Ny_mri = 200

# most parameters are taken from (Chaimow et al., 2011)
rho = 0.5 # main spatial frequency determining columnar width in cycles/mm
delta = 0.3 # variations orthogonal to ODC bands (irregularity)
epsilon = 0.4 # variations parallel to ODC bands (branchiness)
theta = 18 # orientation of the columnar pattern
alpha = 4 # sharpness parameter of the sigmoidal filter
beta = 0.05 # maximal BOLD response corresponding to a neural response of 1
fwhm_BOLD = 2.0 # BOLD point-spread width in mm
fwhm_noise = 0.01 # measurement noise in a.u.
~~~

### White noise input image
Let ($g_{m,n}$) be a $N_x^{sim}\times N_y^{sim}$ sized Gaussian white noise array of independent samples $\mathcal{N}(0,1)$ representing a cortical patch with field of view $FOV_x\times FOV_y$. We compute the discrete Fourier transform $(G_{p,q})$.

$$G_{p,q}=\mathcal{F}\left[g_{m,n}\right]$$

### Band-pass filtering
The anisotropic band-pass filter $\tilde{F}_{p,q}^{ODC}$ is defined as the product of its radial and angular components in spatial frequency space $\boldsymbol k(p,q) = (k_r(p,q),k_{\phi}(p,q))$ which is given in cycles/mm.

$$\tilde{F}_{p,q}^{ODC}(\boldsymbol k):=(F_{p,q}^{rad1} + F_{p,q}^{rad2}) \cdot (F_{p,q}^{ang1} + F_{p,q}^{ang2})$$

with

$$F_{p,q}^{rad1} = \exp\left( -(k_r-\rho)^2 / (2\delta^2) \right)$$
$$F_{p,q}^{rad2} = \exp\left( -(k_r+\rho)^2 / (2\delta^2) \right)$$
$$F_{p,q}^{ang1} = \exp\left( \cos(k_{\phi}-\theta) / \epsilon^2 \right)$$
$$F_{p,q}^{ang2} = \exp\left( -\cos(k_{\phi}-\theta) / \epsilon^2 \right)$$

In order for the filter output to have the same variance as the input (independent of filter parameter values) we normalise the filter.

$$F_{p,q}^{ODC}=\frac{\tilde{F}_{p,q}^{ODC}}{c}$$

with

$$c=\sqrt{\frac{\sum_{p,q=1}^{N_x^{sim}\times N_y^{sim}}\left(\tilde{F}_{p,q}^{ODC}\right)^2}{N_x^{sim}N_y^{sim}}}$$

Instead of convolution with the inverse Fourier transformed ODC kernel, we pointwise multiply both ODC band-pass filter and white noise image in spatial frequency space (see Chaimow et al., 2018b) and then compute the inverse Fourier transformation.

$$\tilde{odc}_{m,n}=\mathcal{F}^{-1}\left[G_{p,q}\cdot F_{p,q}\right]$$

### Thresholding
Instead of using a simple binary threshold, the filtered noise $\tilde{odc}_{m,n}$ is passed through a sigmoidal non-linearity with parameter $\alpha$ that controls the sharpness of the transition from one column to the adjacent column.

$$odc_{m,n}=\frac{2}{1+\exp\left(-\alpha\cdot\tilde{odc}_{m,n}\right)}-1$$

The output array has a range of values from -1 to +1 and defines the monocular regions of the neural map.

### BOLD response
The BOLD spread is formulated as a BOLD response modulation transfer function (Chaimow et al., 2018a) and is defined as

$$F^{BOLD}(\boldsymbol k)=\beta\cdot\exp\left(-2\pi^2\sigma_{BOLD}^2\cdot k_r^2\right)$$

with

$$\sigma_{BOLD}=\frac{fwhm_{BOLD}}{2\sqrt{2\log2}}=\frac{fwhm_{BOLD}}{2.35}$$

It is the Fourier transform of a Gaussian point-spread function with a full-width at half-maximum of $fwhm_{BOLD}$. It is scaled such that a spatially extended neuronal response of 1 results in a BOLD response of amplitude $\beta$.

The spatial frequency representation of the neural map $ODC_{p,q}$ is pointwise multiplied with the BOLD modulation transfer function which yields the BOLD response map.

$$\tilde{y}_{m,n}=\mathcal F^{-1}\left[ODC_{p,q}\cdot F_{p,q}^{BOLD}\right]$$

### Add measurement noise
Random measurement noise $b_{m,n}$ is added to the BOLD response map $\tilde{y}_{p,q}$. The measurement noise forms the baseline of the MR signal. The signal to be sampled is then

$$y_{m,n}=b_{m,n}+\tilde{y}_{m,n}$$

$b_{m,n}$ is drawn from a normal distribution $\mathcal N(\mu_{noise}>0,\sigma_{noise}^2)$ with a standard deviation corresponding to a specific noise level (see Chaimow et al., 2018b) corresponding to $\sigma_{noise}=fwhm_{noise}/2\sqrt{2\log2}$.

### Voxel sampling
MRI sampling is simulated by $k$-space truncation. I.e., there is neither a defined sampling step size nor consideration of relaxation parameters (cf. Chaimow et al., 2016). The truncation is performed by only considering inner $k$-space lines in $N_x^{MRI}\times N_y^{MRI}$ of the signal to be sampled $Y_{p,q}$.

$$y_{m,n}^{MRI}=\mathcal{F}^{-1}\left[Y_{p,q}\right]\quad\text{with}\quad (p,q)\in[0,N_x^{MRI}]\times[0,N_y^{MRI}]$$

# References
- Chaimow, D., Yacoub, E., Ugurbil, K., Shmuel, A. (2011) Modeling and analysis of mechanisms underlying fMRI-based decoding of information conveyed in cortical columns, *NeuroImage*, 56(2), pp. 627--642.
- Chaimow, D., Shmuel, A. (2016) A more accurate account of the effect of k-space sampling and signal decay on the effective spatial resolution in functional MRI, *bioRxiv*, pp. 1--35.
- Chaimow, D., Yacoub, E., Ugurbil, K., Shmuel, A. (2018a) Spatial specificity of the functional MRI blood oxygenation response relative to neuronal activity, *NeuroImage*, 164, pp. 32--47.
- Chaimow, D., Ugurbil, K., Shmuel, A. (2018b), Optimization of functional MRI for detection, decoding and high-resolution imaging of the response patterns of cortical columns, *NeuroImage*, 164, pp. 67--99.
- Goncalves, N.R., Ban, H., Sanchez-Panchuelo, R.M., Francis, S.T., Schluppeck, D, Welchman, A.E. (2015) 7 Tesla fMRI Reveals Systematic Functional Organization for Binocular Disparity in Dorsal Visual Cortex, *J Neurosci*, 35(7), pp. 3056--3072.
- Rojer, A.S., Schwartz, E.L. (1990) Cat and monkey cortical columnar patterns modeled by bandpass-filtered 2D white noise, *Biol Cybern*, 62(5), pp. 381--391.
